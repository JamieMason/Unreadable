#!/usr/bin/env node

var program = require('commander');
var fs = require('fs');
var exec = require('child_process').exec;
var postProcess;
var command;
var proc;
var output;
var taskName;
var nodeTask;
var nodeTaskPath;
var commandToClass = {
      summary: 'DocumentSummary',
      minify: 'ComputedStyleMinify'
    };

program
  .version('0.0.1')
  .option('-h --help', 'Show this message')
  .option('-u --url [value]', 'URL to process')
  .option('-t --task [value]', 'Task name to perform')
  .parse(process.argv);

taskName = program.task;
taskName = taskName in commandToClass ? commandToClass[taskName] : taskName;
nodeTaskPath = __dirname + '/src/' + taskName + '-node.js';

if(fs.existsSync(nodeTaskPath)) {
  nodeTask = require(nodeTaskPath);
}

command = 'phantomjs "' + __dirname + '/src/asterisk.js" "' + __dirname + '" "' + program.url + '" "' + taskName + '" --web-security=no --local-to-remote-url-access=yes --load-images=no';

proc = exec(command, function(error, stdout, stderr) {

  if(error !== null) {
    console.error(error);
  } else if (nodeTask) {
    nodeTask.processBrowserOutput(stdout);
  } else {
    console.log(stdout);
  }

});
